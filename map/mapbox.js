const mapObjects = 'mapObjectsFromPHP' in window ? mapObjectsFromPHP : {
    340: {
        "geoName": "Robert-Rössle-Straße",
        "quarter": "Buch",
        "shortDesc": "<p><span data-sheets-value=\"{&quot;1&quot;:2,&quot;2&quot;:&quot;Der deutsche Pathologe Robert Rössle (1879 - 1956) setzte sich im Nationalsozialismus für die sogenannte Eugenik ein. Er unterzog zahlreiche im Namen der “Rassenhygiene” menschenverachtenden Experimenten und veröffentlichte rassistische und ableistische Schriften.\\n&quot;}\" data-sheets-userformat=\"{&quot;2&quot;:15105,&quot;3&quot;:{&quot;1&quot;:0},&quot;11&quot;:4,&quot;12&quot;:0,&quot;14&quot;:{&quot;1&quot;:2,&quot;2&quot;:0},&quot;15&quot;:&quot;Arial&quot;,&quot;16&quot;:10}\">Der deutsche Pathologe Robert Rössle (1879 &#8211; 1956) setzte sich im Nationalsozialismus für die sogenannte Eugenik ein. Er unterzog zahlreiche im Namen der “Rassenhygiene” menschenverachtenden Experimenten und veröffentlichte rassistische und ableistische Schriften.<br />\n</span></p>\n",
        "longDesc": "<p><a href=\"https://viaf.org/viaf/56674994/\"><span style=\"font-weight: 400;\">Robert Rössle</span></a><span style=\"font-weight: 400;\"> studierte in München, Kiel und Straßburg Medizin. Nach der Habilitation arbeitete er in Jena und Basel, bis er 1929 an den Lehrstuhl für Pathologie der Charité Berlin berufen wurde, welchen er bis 1948 leitete. </span></p>\n<p><span style=\"font-weight: 400;\">Rössle war schon vor der Machtergreifung Hitlers ein Verfechter der </span><b>Eugenik</b><span style=\"font-weight: 400;\">, die im Nationalsozialismus als Rechtfertigung des Mordes an Menschen mit körperlichen und geistigen Behinderungen diente. </span></p>\n<p><span style=\"font-weight: 400;\">In den 1930er Jahren ließ er zu Forschungszwecken Gefangene aus dem Untersuchungsgefängnis Moabit kastrieren, die wegen “Sittlichkeitsverbrechen”, zum Beispiel Homosexualität, &#8211; inhaftiert waren und sezierte ihre Hoden. Parallel wirkte er mit bei der, von </span><a href=\"http://viaf.org/viaf/20489377\"><span style=\"font-weight: 400;\">Günther Just</span></a><span style=\"font-weight: 400;\"> (1892 &#8211; 1950) und </span><a href=\"http://viaf.org/viaf/27189075\"><span style=\"font-weight: 400;\">Karl Heinrich Bauer</span></a><span style=\"font-weight: 400;\"> (1890 &#8211; 1978) ab 1935 herausgegebenen, eugenischen “Zeitschrift für menschliche Vererbungs- und Konstitutionslehre”. 1936 wurde er aufgrund seiner Forschung in die Deutsche Akademie der Naturforscher Leopoldina aufgenommen. </span></p>\n<p><span style=\"font-weight: 400;\">Rössle erhielt </span><a href=\"https://taz.de/Umstrittene-Strassennamen-in-Berlin/!5665893/\"><span style=\"font-weight: 400;\">nach Recherchen von Biochemikerin Ute Linz</span></a><span style=\"font-weight: 400;\"> auch Gehirne von </span><a href=\"http://viaf.org/viaf/77126043\"><span style=\"font-weight: 400;\">Julius Hallervorden</span></a><span style=\"font-weight: 400;\"> (1882 &#8211; 1968). Der stellvertretende Direktor am Kaiser-Wilhelm-Institut für Hirnforschung (KWI), untersuchte rund 700 Gehirne von Kindern und Jugendlichen aus Brandenburg untersuchte, die bei der “Aktion T4” ermordet wurden.</span></p>\n<p><span style=\"font-weight: 400;\">Am 18. August 1942 berief ihn Adolf Hitler in den wissenschaftlichen Senat des Heeressanitätswesens.</span></p>\n<p><span style=\"font-weight: 400;\">Rössle beteiligte sich möglicherweise auch an der auf Menschenversuchen basierenden Luftwaffenforschung über “Die pathologisch-anatomischen Veränderungen bei Druckfallkrankheit und Luftstoßschäden”. Wie genau seine Beteiligng hier aussah sei aber unklar. </span></p>\n<p><span style=\"font-weight: 400;\">1944 wurde Rössle in den Wissenschaftlichen Beirat des “Generalkommissars für das Sanitäts- und Gesundheitswesen” von Dr. Karl Brandt berufen. Die “</span><a href=\"https://portal.ehri-project.eu/units/de-002429-r_185\"><span style=\"font-weight: 400;\">Aktion Brandt</span></a><span style=\"font-weight: 400;\">” umfasste den Mord an Menschen mit Behinderung aus Heil- und Pflegeanstalten, um freie Krankenhausbetten für Kriegsopfer zu schaffen.</span></p>\n<h3><span style=\"font-weight: 400;\">Karriere nach dem Nationalsozialismus</span></h3>\n<p><span style=\"font-weight: 400;\">Da Rössle kein NSDAP-Mitglied gewesen war, lehrte er nach dem Ende des Zweiten Weltkriegs weiterhin an der </span><a href=\"https://www.sammlungen.hu-berlin.de/objekte/-/16737/\"><span style=\"font-weight: 400;\">Humboldt-Universität zu Berlin</span></a><span style=\"font-weight: 400;\">. Nach der Emeritierung arbeitete er bis 1953 am Städtischen Wenckebach-Krankenhaus in Berlin und widmete sich anschließend experimentellen Studien am Institut für Gewebeforschung.</span></p>\n<p><span style=\"font-weight: 400;\">Rössle wurde 1949 mit dem Nationalpreis der DDR ausgezeichnet, er erhielt mehrere Ehrendoktorwürden, war Ehrenmitglied von elf wissenschaftlichen Gesellschaften und Mitglied der </span><a href=\"https://www.bbaw.de/die-akademie/akademie-historische-aspekte/mitglieder-historisch/historisches-mitglied-robert-roessle-2299\"><span style=\"font-weight: 400;\">Preußischen Akademie der Wissenschaften in Berlin</span></a><span style=\"font-weight: 400;\">. 1952 erhielt er das Verdienstkreuz der Bundesrepublik Deutschland. Robert Rössle starb 1956 in Berlin.</span></p>\n<p><span style=\"font-weight: 400;\">Drei Jahre nach seinem Tod wurde das 1959 gegründete Akademieinstitut für Medizin und Biologie der DDR &#8211; ein ehemaliges Kaiser-Wilhelm-Institut &#8211; in Robert-Rössle-Klinik umbenannt.</span></p>\n<p><span style=\"font-weight: 400;\">Zwischen 1947-1991 wurden am Campus Berlin-Buch eine Reihe von Gedenkbüsten aufgestellt, um an Wissenschaftler:innen und Ärzt:innen zu erinnern, die am Wiederaufbau nach dem Zweiten Weltkrieg beteiligt waren. 1960 wurde vor der Robert-Rössle-Klinik eine von Gerhard Thieme (1928 &#8211; 2018) geschaffene </span><a href=\"https://bildhauerei-in-berlin.de/bildwerk/denkmal-robert-roessle/\"><span style=\"font-weight: 400;\">Porträtbüste</span></a><span style=\"font-weight: 400;\"> aufgestellt und 1974 die Straße zum Campus nach ihm benannt. Die Klinik heißt seit 2001 nicht mehr nach Robert Rössle, da sie vom privaten Helios Konzern gekauft wurde, allerdings finden sich noch einige Beschilderungen oder Online-Einträge bei Google, die den alten Namen tragen.</span></p>\n",
        "currentSituation": "<p><span style=\"font-weight: 400;\">Die </span><a href=\"https://taz.de/Umstrittene-Strassennamen-in-Berlin/!5665893/\"><span style=\"font-weight: 400;\">Biochemikerin Ute Linz</span></a><span style=\"font-weight: 400;\"> engagiert sich für die neue, historische Aufarbeitung von Robert Rössle. Sie hat in den vergangenen Jahren Material über ihn zusammengetragen, die eine umfassende historische Aufarbeitung und Umbenennung ihrer Meinung nach dringend notwendig machen. Im November 2015 wandte sie sich erstmals brieflich ans Bezirksamt Pankow, die Nachforschungen verspraechen. Als daraufhin nichts passierte, wendet sie sich am 4. Februar 2017 mit einer Petition an die Bezirksverordnetenversammlung (BVV). </span></p>\n<p><span style=\"font-weight: 400;\">Der stellvertretende Direktor des Instituts für Geschichte der Medizin und Ethik in der Medizin an der Charité Berlin Thomas Beddies äußerte sich gegenüber einer Umbenennung kritisch und plädiert für eine kritische Kontextualisierung des Namens ”im Sinne einer lebendigen Erinnerungs- und Mahnkultur” </span><a href=\"https://taz.de/Umstrittene-Strassennamen-in-Berlin/!5665893/\"><span style=\"font-weight: 400;\">(taz)</span></a><span style=\"font-weight: 400;\">. Ute Linz widerspricht dieser Idee als nicht angemessen und schlug vor der Straße wieder den alten Namen “Pappelweg” zu geben.</span></p>\n",
        "recommendation": "",
        "author": [ "Clara Westendorff" ],
        "literature": "",
        "image": false,
        "name": "Robert-Rössle-Straße",
        "link": "https://strassenlaerm.berlin/robert-roessle-strasse/"
    }
}
console.log(mapObjects);


mapboxgl.accessToken = 'pk.eyJ1Ijoic3RyYXNzZW5sYWVybSIsImEiOiJja2s0ZHl3YXgxMzFnMndvYmhiY2oyMm5uIn0.jnfXWu8Bb-wd2A9FMo1fEg';
const center = [13.381, 52.522];
const zoom = 10;
const pad = 50;
const map = new mapboxgl.Map({
    container: 'map',
    style: 'mapbox://styles/strassenlaerm/ckk4e90yl5bid17nyu9uangjg', // stylesheet location
    // center, // starting position [lng, lat]
    // zoom, // starting zoom
})
    .addControl(new mapboxgl.FullscreenControl(), 'top-left')
    .addControl(new mapboxgl.NavigationControl(), 'top-left')
    .addControl(new mapboxgl.GeolocateControl({
        positionOptions: { enableHighAccuracy: true },
        trackUserLocation: true
    }), 'top-left');

const layers = ['strassen-touch', 'plaetze'];
let features;
let selectedPoint = map.getCenter();
const originalTitle = document.title;

const popupOptions = {
    className: 'streetsign attached',
    maxWidth: '400px',
    offset: 30,
};
const expPopup = new mapboxgl.Popup(popupOptions);
const popup = new mapboxgl.Popup({...popupOptions, closeButton: false});

const id = 340; // just mocked

map.on('load', () => {
    features = map.queryRenderedFeatures({ layers });
    console.log(features);
    loadDescription();
    layers.map(layer => {
        map.on('mouseenter', layer, e => {
            // Change the cursor to a pointer when the mouse is over the places layer.
            map.getCanvas().style.cursor = 'pointer';

            // const props = mapObjects[e.features[0].id];
            const props = mapObjects[id];
            const html = `<div class="desc"><h2>${props.name}</h2></div><div class="more">1 - 99</div>`;

            popup
                .trackPointer()
                // .setLngLat(e.lngLat)
                .setHTML(html)
                .addTo(map);
        });
        map.on('mouseleave', layer, () => {
            // Change it back to a pointer when it leaves.
            map.getCanvas().style.cursor = '';
            popup.remove();
        });

        map.on('click', layer, e => {
            selectedPoint = e.lngLat;
            const props = mapObjects[id];
            const html = `<div class="desc"><h2>${props.name} (${props.quarter})</h2><p>${props.shortDesc}</p></div>`
                       + `<div class="more"><a href="#${id}-${props.link.split('/')[3]}"> > mehr </a></div>`;

            expPopup
                .setLngLat(e.lngLat)
                .setHTML(html)
                .addTo(map);

            // add class with timeout to trigger css transitions
            setTimeout(() => expPopup.addClassName('expanded'), 1)
        });

    })
});

function loadDescription() {
    expPopup.remove();
    if(location.hash) {
        const id = parseInt(location.hash.split('-')[0].substr(1));
        // const clickedObj = features.find(feature => feature.properties.wp_id === id);
        const clickedObj = features[0];
        const props = mapObjects[id];
        document.querySelector('object-information').object = mapObjects[id];
        map.fitBounds(
            getBoundingBox(clickedObj.geometry),
            {padding: {top: pad, bottom: pad, left: pad, right: window.innerWidth / 4 + 170 + pad}},
        );
        document.title = `${props.name} (${props.quarter}) | ${originalTitle}`
    } else {
        document.querySelector('object-information').object = null;
        map.flyTo({center, zoom});
        document.title = originalTitle;
    }
}

window.onhashchange = loadDescription;

function getBoundingBox(geom) {
    const points = geom.type === 'LineString' ? geom.coordinates : geom.coordinates.flat();
    let latitude, longitude, xMin, xMax, yMin, yMax;

    points.forEach(point => {
        longitude = point[0];
        latitude = point[1];
        xMin = xMin < longitude ? xMin : longitude;
        xMax = xMax > longitude ? xMax : longitude;
        yMin = yMin < latitude ? yMin : latitude;
        yMax = yMax > latitude ? yMax : latitude;
    });
    return [[xMin, yMin], [xMax, yMax]];
}

function getBoundingBoxCenter(data) {
    const bbox = getBoundingBox(data);
    let longitude = (bbox[0][0] + bbox[1][0])/2;
    let latitude = (bbox[0][1] + bbox[1][1])/2;
    return [longitude, latitude];
}
